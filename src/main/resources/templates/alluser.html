<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>User List</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">MyApp</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
				aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<li class="nav-item">
						<a class="nav-link active" aria-current="page" th:href="@{/home}">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" th:href="@{/products}">Products</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" th:href="@{/cart}">Cart</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" th:href="@{/orders}">Orders</a>
					</li>
				</ul>

				<!-- Right side of navbar (e.g. User Account) -->
				<ul class="navbar-nav ms-auto">
					<li class="nav-item" th:if="${session.user != null}">
						<a class="nav-link" th:text="'Welcome, ' + ${session.user.username}" th:href="@{/profile}"></a>
					</li>
					<li class="nav-item" th:if="${session.user == null}">
						<a class="nav-link" th:href="@{/login}">Login</a>
					</li>
					<li class="nav-item" th:if="${session.user != null}">
						<a class="nav-link" th:href="@{/logout}">Logout</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container">
		<h1>User List</h1>
		<table class="table table-bordered">
			<thead>
				<tr>
					<th>First Name</th>
					<th>Middle Name</th>
					<th>Last Name</th>
					<th>Email</th>
					<th>Mobile</th>
					<th>Status</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="user : ${users}">
					<td th:text="${user.fname}"></td>
					<td th:text="${user.mname}"></td>
					<td th:text="${user.lname}"></td>
					<td th:text="${user.email}"></td>
					<td th:text="${user.mobile}"></td>
					<td>
						<span th:text="${user.status == 1 ? 'Active' : 'Inactive'}"></span>
					</td>
					<td>
						<button type="button" class="btn btn-warning"
							th:onclick="'updateStatus(' + ${user.id} + ', ' + ${user.status} + ')'">
							<span th:text="${user.status == 1 ? 'Deactivate' : 'Activate'}"></span>
						</button>
					</td>

					<td>
						<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#updateModal"
							th:data-id="${user.id}" th:data-fname="${user.fname}" th:data-mname="${user.mname}"
							th:data-lname="${user.lname}" th:data-email="${user.email}" th:data-mobile="${user.mobile}"
							th:data-roles="${user.roles}">
							Update
						</button>

					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- Update Modal -->
	<div class="modal fade" id="updateModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Update User</h5>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<form th:action="@{/updateRole}" method="post">
						<!-- Simulate PUT request with hidden field -->
						<input type="hidden" name="_method" value="PUT" />

						<input type="hidden" name="id" id="userId" />
						<input type="text" class="form-control" id="firstName" name="fname" placeholder="First Name"
							readonly />
						<input type="text" class="form-control mt-2" id="middleName" name="mname"
							placeholder="Middle Name" readonly />
						<input type="text" class="form-control mt-2" id="lastName" name="lname" placeholder="Last Name"
							readonly />
						<input type="email" class="form-control mt-2" id="email" name="email" placeholder="Email"
							readonly />
						<input type="text" class="form-control mt-2" id="mobile" name="mobile" placeholder="Mobile"
							readonly />

						<div class="form-group mt-2">
							<label for="roles">Roles</label>
							<select class="form-control" id="roles" name="roles" required>
								<option value="" disabled selected>Select Role</option>
								<option value="ROLE_ADMIN">Admin</option>
								<option value="ROLE_USER">User</option>
								<option value="ROLE_NURSE">Nurse</option>
								<option value="ROLE_DOCTOR">Doctor</option>
								<option value="ROLE_PHARMASSIST">Pharmacist</option>
							</select>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							<button type="submit" class="btn btn-primary">Save changes</button>
						</div>
					</form>

				</div>
			</div>
		</div>
	</div>

	<script>
		$(function () {
			$('#updateModal').on('show.bs.modal', function (event) {
				var button = $(event.relatedTarget);
				var modal = $(this);

				modal.find('#firstName').val(button.data('fname'));
				modal.find('#middleName').val(button.data('mname'));
				modal.find('#lastName').val(button.data('lname'));
				modal.find('#email').val(button.data('email'));
				modal.find('#mobile').val(button.data('mobile'));

				// Set the user ID in the hidden input field
				modal.find('#userId').val(button.data('id'));

				// Set the selected role in the dropdown
				var role = button.data('roles');
				modal.find('#roles').val(role);
			});
		});




		function updateStatus(id, currentStatus) {
			const newStatus = currentStatus == 1 ? 0 : 1;
			fetch(`/updateStatus/${id}/${newStatus}`, {
				method: 'PUT',
			})
				.then(response => {
					if (response.ok) {
						window.location.reload(); // reload the page to see updated statuses
					} else {
						alert('Error updating status');
					}
				});
		}

	</script>
</body>

</html>